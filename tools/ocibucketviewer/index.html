<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OCIオブジェクトストレージビューワー</title>
  <link rel="stylesheet" href="../../design-system/src/global.css">
  <link rel="stylesheet" href="../../design-system/src/components/drawer/drawer.css">
  <link rel="stylesheet" href="../../design-system/src/components/hamburger-menu-button/hamburger-menu-button.css">
  <link rel="stylesheet" href="../../design-system/src/components/input-text/input-text.css">
  <link rel="stylesheet" href="../../design-system/src/components/select/select.css">
  <link rel="stylesheet" href="../../design-system/src/components/form-control-label/form-control-label.css">
  <link rel="stylesheet" href="../../design-system/src/components/button/button.css">
  <link rel="stylesheet" href="../../design-system/src/components/table/table.css">
  <link rel="stylesheet" href="../../design-system/src/components/notification-banner/notification-banner.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <style>
    html {
      scrollbar-gutter: stable;
      /* 2 */
    }

    html:has(:modal) {
      overflow: clip;
      /* 1 */
      scrollbar-gutter: auto;
      /* 2 */
    }

    body:has(:modal) {
      overflow: auto;
      /* 1 */
      scrollbar-gutter: stable;
      /* 2 */
    }

    #error_modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 114514;
      display: none;
    }
  </style>

</head>

<body>

  <div class="page-wrapper" style="width:90vw; max-width:1200px; margin:auto; margin-top:2em;">

    <!-- メニュー -->
    <div
      style="position: fixed; top: 0; right: 0; left: 0; display: flex; padding: calc(20 / 16 * 1rem) calc(16 / 16 * 1rem); justify-content: end">
      <button class="dads-hamburger-menu-button" type="button" command="show-modal" commandfor="dads-drawer">
        <svg class="dads-hamburger-menu-button__icon" width="24" height="24" viewBox="0 0 24 24" aria-hidden="true">
          <path d="M3 18V16H21V18H3ZM3 13V11H21V13H3ZM3 8V6H21V8H3Z" fill="currentcolor"></path>
        </svg>
        メニュー
      </button>
    </div>

    <!-- ドロワー(メニューの中身) -->
    <dialog id="dads-drawer" class="dads-drawer" data-placement="right" aria-labelledby="dads-drawer-heading">
      <h2 id="dads-drawer-heading" class="dads-u-visually-hidden">メニュー</h2>
      <div class="dads-drawer__header">
        <button class="dads-hamburger-menu-button" type="button" command="close" commandfor="dads-drawer">
          <svg class="dads-hamburger-menu-button__icon" width="24" height="24" viewBox="0 0 120 120" aria-hidden="true">
            <path d="M32 95L25 88L53 60L25 32L32 25L60 53L88 25L95 32L67 60L95 88L88 95L60 67L32 95Z"
              fill="currentcolor"></path>
          </svg>
          閉じる
        </button>
      </div>
      <div class="dads-drawer__body">
        <div style="display: flex; flex-flow: column; row-gap: 1rem; padding: 1rem;">

          <!-- リージョン -->
          <div class="dads-form-control-label" data-size="md">
            <label class="dads-form-control-label__label" for="region">
              リージョン
              <span class="dads-form-control-label__requirement" data-required="true">※必須</span>
            </label>
            <div>
              <span class="dads-select">
                <span class="dads-select__control" style="width:100%;">
                  <select id="region" class="dads-select__select" data-size="md" aria-invalid="false"
                    aria-describedby="with-label-error-text with-label-support-text" style="width:100%;">
                    <option value=""></option>
                    <option value="ap-sydney-1">ap-sydney-1</option>
                    <option value="ap-melbourne-1">ap-melbourne-1</option>
                    <option value="sa-saopaulo-1">sa-saopaulo-1</option>
                    <option value="sa-vinhedo-1">sa-vinhedo-1</option>
                    <option value="ca-montreal-1">ca-montreal-1</option>
                    <option value="ca-toronto-1">ca-toronto-1</option>
                    <option value="sa-santiago-1">sa-santiago-1</option>
                    <option value="sa-valparaiso-1">sa-valparaiso-1</option>
                    <option value="sa-bogota-1">sa-bogota-1</option>
                    <option value="eu-paris-1">eu-paris-1</option>
                    <option value="eu-marseille-1">eu-marseille-1</option>
                    <option value="eu-frankfurt-1">eu-frankfurt-1</option>
                    <option value="ap-hyderabad-1">ap-hyderabad-1</option>
                    <option value="ap-mumbai-1">ap-mumbai-1</option>
                    <option value="ap-batam-1">ap-batam-1</option>
                    <option value="il-jerusalem-1">il-jerusalem-1</option>
                    <option value="eu-milan-1">eu-milan-1</option>
                    <option value="eu-turin-1">eu-turin-1</option>
                    <option value="ap-osaka-1">ap-osaka-1</option>
                    <option value="ap-tokyo-1">ap-tokyo-1</option>
                    <option value="mx-queretaro-1">mx-queretaro-1</option>
                    <option value="mx-monterrey-1">mx-monterrey-1</option>
                    <option value="eu-amsterdam-1">eu-amsterdam-1</option>
                    <option value="me-riyadh-1">me-riyadh-1</option>
                    <option value="me-jeddah-1">me-jeddah-1</option>
                    <option value="eu-jovanovac-1">eu-jovanovac-1</option>
                    <option value="ap-singapore-1">ap-singapore-1</option>
                    <option value="ap-singapore-2">ap-singapore-2</option>
                    <option value="af-johannesburg-1">af-johannesburg-1</option>
                    <option value="ap-seoul-1">ap-seoul-1</option>
                    <option value="ap-chuncheon-1">ap-chuncheon-1</option>
                    <option value="eu-madrid-1">eu-madrid-1</option>
                    <option value="eu-madrid-3">eu-madrid-3</option>
                    <option value="eu-stockholm-1">eu-stockholm-1</option>
                    <option value="eu-zurich-1">eu-zurich-1</option>
                    <option value="me-abudhabi-1">me-abudhabi-1</option>
                    <option value="me-dubai-1">me-dubai-1</option>
                    <option value="uk-london-1">uk-london-1</option>
                    <option value="uk-cardiff-1">uk-cardiff-1</option>
                    <option value="us-ashburn-1">us-ashburn-1</option>
                    <option value="us-chicago-1">us-chicago-1</option>
                    <option value="us-phoenix-1">us-phoenix-1</option>
                    <option value="us-sanjose-1">us-sanjose-1</option>
                  </select>
                  <svg class="dads-select__chevron" width="16" height="16" viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M12 17L3 8L4 7L12 15L20 7L21 8L12 17Z" fill="currentcolor"></path>
                  </svg> </span>
                <span id="region-empty-error" class="dads-select__error-text" style="display:none;">＊選択してください。</span>
              </span>
            </div>
          </div>

          <!-- ネームスペース -->
          <div class="dads-form-control-label" data-size="md">
            <label class="dads-form-control-label__label" for="with-label-input">
              ネームスペース
              <span class="dads-form-control-label__requirement" data-required="true">※必須</span>
            </label>
            <div>
              <span class="dads-input-text">
                <input id="namespace" class="dads-input-text__input" type="text" data-size="md" aria-invalid="false"
                  aria-describedby="with-label-error-text with-label-support-text">
                <span id="namespace-empty-error" class="dads-input-text__error-text"
                  style="display:none;">＊入力してください。</span>
              </span>
            </div>
          </div>

          <!-- バケット名 -->
          <div class="dads-form-control-label" data-size="md">
            <label class="dads-form-control-label__label" for="with-label-input">
              バケット名
              <span class="dads-form-control-label__requirement" data-required="true">※必須</span>
            </label>
            <div>
              <span class="dads-input-text">
                <input id="path" class="dads-input-text__input" type="text" data-size="md" aria-invalid="false"
                  aria-describedby="with-label-error-text with-label-support-text">
                <span id="path-empty-error" class="dads-input-text__error-text" style="display:none;">＊入力してください。</span>
              </span>
            </div>
          </div>

          <!-- プライベートキー -->
          <div class="dads-form-control-label" data-size="md">
            <label class="dads-form-control-label__label" for="with-label-input">
              プライベートキー
              <span class="dads-form-control-label__requirement" data-required="true">※必須</span>
            </label>
            <div>
              <span class="dads-input-text">
                <input id="private-key" class="dads-input-text__input" type="password" data-size="md"
                  aria-invalid="false" aria-describedby="with-label-error-text with-label-support-text">
                <span id="private-key-empty-error" class="dads-input-text__error-text"
                  style="display:none;">＊入力してください。</span>
              </span>
            </div>
          </div>

          <button class="dads-button" data-size="md" data-type="outline" style="width:100%;"
            onclick="applySettings()">適用</button>

        </div>
      </div>
    </dialog>

    <!-- コンテンツ -->
    <div class="dads-table" data-size="dense" data-row-stripe data-row-hover-highlight style=" margin-top:4em;">
      <table class="dads-table__table" data-width="full">
        <thead>
          <tr>
            <th class="dads-table__col-header" scope="col">ファイル名</th>
            <th class="dads-table__col-header" scope="col">サイズ</th>
            <th class="dads-table__col-header" scope="col">更新日時</th>
            <th class="dads-table__col-header" scope="col">ダウンロード</th>
          </tr>
        </thead>
        <tbody id="file-list-body">
          <tr>
            <td>
              <div style="height: 1.5rem; background-color: var(--color-neutral-solid-gray-100);"></div>
            </td>
            <td>
              <div style="height: 1.5rem; background-color: var(--color-neutral-solid-gray-100);"></div>
            </td>
            <td>
              <div style="height: 1.5rem; background-color: var(--color-neutral-solid-gray-100);"></div>
            </td>
            <td>
              <div style="height: 1.5rem; background-color: var(--color-neutral-solid-gray-100);"></div>
            </td>
          </tr>
          <tr>
            <td>
              <div style="height: 1.5rem; background-color: var(--color-neutral-solid-gray-100);"></div>
            </td>
            <td>
              <div style="height: 1.5rem; background-color: var(--color-neutral-solid-gray-100);"></div>
            </td>
            <td>
              <div style="height: 1.5rem; background-color: var(--color-neutral-solid-gray-100);"></div>
            </td>
            <td>
              <div style="height: 1.5rem; background-color: var(--color-neutral-solid-gray-100);"></div>
            </td>
          </tr>
          <tr>
            <td>
              <div style="height: 1.5rem; background-color: var(--color-neutral-solid-gray-100);"></div>
            </td>
            <td>
              <div style="height: 1.5rem; background-color: var(--color-neutral-solid-gray-100);"></div>
            </td>
            <td>
              <div style="height: 1.5rem; background-color: var(--color-neutral-solid-gray-100);"></div>
            </td>
            <td>
              <div style="height: 1.5rem; background-color: var(--color-neutral-solid-gray-100);"></div>
            </td>
          </tr>
          <tr>
            <td>
              <div style="height: 1.5rem; background-color: var(--color-neutral-solid-gray-100);"></div>
            </td>
            <td>
              <div style="height: 1.5rem; background-color: var(--color-neutral-solid-gray-100);"></div>
            </td>
            <td>
              <div style="height: 1.5rem; background-color: var(--color-neutral-solid-gray-100);"></div>
            </td>
            <td>
              <div style="height: 1.5rem; background-color: var(--color-neutral-solid-gray-100);"></div>
            </td>
          </tr>
          <tr>
            <td>
              <div style="height: 1.5rem; background-color: var(--color-neutral-solid-gray-100);"></div>
            </td>
            <td>
              <div style="height: 1.5rem; background-color: var(--color-neutral-solid-gray-100);"></div>
            </td>
            <td>
              <div style="height: 1.5rem; background-color: var(--color-neutral-solid-gray-100);"></div>
            </td>
            <td>
              <div style="height: 1.5rem; background-color: var(--color-neutral-solid-gray-100);"></div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

  </div>

  <!-- エラーモーダル -->
  <div id="modal_background" style="position: fixed; top:0; left:0; width:100vw; height:100vh; background-color: rgba(0,0,0,0.5); z-index:114513; display:none;"></div>
  <div id="error_modal" style="position: fixed; z-index:114514;">
    <div class="dads-notification-banner" data-style="standard" data-type="error">
      <h2 class="dads-notification-banner__heading">
        <svg class="dads-notification-banner__icon" width="24" height="24" viewBox="0 0 24 24" role="img"
          aria-label="エラー">
          <path d="M8.25 21 3 15.75v-7.5L8.25 3h7.5L21 8.25v7.5L15.75 21h-7.5Z" fill="currentcolor"></path>
          <path
            d="m12 13.4-2.85 2.85-1.4-1.4L10.6 12 7.75 9.15l1.4-1.4L12 10.6l2.85-2.85 1.4 1.4L13.4 12l2.85 2.85-1.4 1.4L12 13.4Z"
            fill="Canvas"></path>
        </svg>
        <span class="dads-notification-banner__heading-text">
          操作を完了できませんでした
        </span>
      </h2>
      <button class="dads-notification-banner__close" type="button" aria-labelledby="error-close-label" onclick="hideErrorModal()">
        <svg class="dads-notification-banner__close-icon" width="24" height="24" viewBox="0 0 24 24" aria-hidden="true">
          <path d="m6.4 18.6-1-1 5.5-5.6-5.6-5.6 1.1-1 5.6 5.5 5.6-5.6 1 1.1L13 12l5.6 5.6-1 1L12 13l-5.6 5.6Z"
            fill="currentcolor"></path>
        </svg>
        <span id="error-close-label" class="dads-notification-banner__close-label">閉じる</span>
      </button>
      <div class="dads-notification-banner__body">
        <p class="dads-notification-banner__timestamp">
          <time id="error-timestamp" datetime=""></time>
        </p>
        <p id="error-message">エラーが発生しました。</p>
      </div>
    </div>
  </div>

</body>

<script>
  // 初回アクセス時，ハッシュパラメータがあれば取得
  const hashParams = new URLSearchParams(window.location.hash.substring(1));
  var ns = hashParams.get("ns");
  var pk = hashParams.get("pk");
  var path = hashParams.get("path");
  var reg = hashParams.get("reg");
  var preauth_url = "";

  if (ns && pk && path && reg) {
    document.getElementById("namespace").value = ns;
    document.getElementById("private-key").value = pk;
    document.getElementById("path").value = path;
    document.getElementById("region").value = reg;
    preauth_url = `https://${ns}.objectstorage.${reg}.oci.customer-oci.com/p/${pk}/n/${ns}/b/${path}/o/`;
    Connect(preauth_url)
  }


  function formatSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  }

  function showError(message) {
    document.getElementById('file-list-body').innerHTML = ''; // テーブル内容クリア

    const errorModal = document.getElementById("error_modal");
    const errorMessage = document.getElementById("error-message");
    const errorTimestamp = document.getElementById("error-timestamp");

    errorMessage.textContent = message;
    const now = new Date();
    errorTimestamp.textContent = now.toLocaleString('ja-JP');
    errorTimestamp.setAttribute("datetime", now.toISOString());

    errorModal.style.display = "block";
    document.getElementById("modal_background").style.display = "block";
  }

  function hideErrorModal() {
    document.getElementById("error_modal").style.display = "none";
    document.getElementById("modal_background").style.display = "none";
  }

  async function listOCIObjects(_preauth_url) {
    // 1. オブジェクト一覧(JSON)取得
    const res = await fetch(_preauth_url);
    if (!res.ok) {
      if (res.status === 401) {
        throw new Error("認証に失敗しました。プライベートキーを確認してください。");
      } else {
        throw new Error("一覧取得失敗");
      }
    }
    const data = await res.json();

    const results = [];

    // 2. 各オブジェクトにHEADリクエスト
    for (const obj of data.objects) {
      const link = _preauth_url + obj.name;
      const headRes = await fetch(link, { method: "HEAD" });
      if (!headRes.ok) {
        if (headRes.status === 401) {
          throw new Error("認証に失敗しました。プライベートキーを確認してください。");
        } else {
          throw new Error(`HEAD失敗: ${obj.name}`);
        }
      }

      const size = Number(headRes.headers.get("Content-Length"));
      const lastModified = headRes.headers.get("Last-Modified");

      // 3. name, size, link, lastModified を持つ連想配列を作成
      results.push({
        name: obj.name,
        size: size,
        link: link,
        lastModified: lastModified
      });
    }

    return results;
  }

  function Connect(_preauth_url) {
    listOCIObjects(_preauth_url)
      .then(list => {
        const tbody = document.getElementById('file-list-body');
        tbody.innerHTML = ''; // 既存の要素を削除

        list.forEach(item => {
          const tr = document.createElement('tr');

          const tdName = document.createElement('td');
          tdName.textContent = item.name;

          const tdSize = document.createElement('td');
          tdSize.textContent = formatSize(item.size);

          const tdLastModified = document.createElement('td');
          tdLastModified.textContent = new Date(item.lastModified).toLocaleString('ja-JP');

          const tdDownload = document.createElement('td');
          const a = document.createElement('a');
          a.href = item.link;
          a.textContent = 'ダウンロード';
          a.download = item.name;
          tdDownload.appendChild(a);

          tr.appendChild(tdName);
          tr.appendChild(tdSize);
          tr.appendChild(tdLastModified);
          tr.appendChild(tdDownload);

          tbody.appendChild(tr);
        });
      })
      .catch(err => showError(err.message));
  }


  function applySettings() {
    // 入力値取得
    const namespace = document.getElementById("namespace").value;
    const bucketPath = document.getElementById("path").value;
    const privateKey = document.getElementById("private-key").value;
    const region = document.getElementById("region").value;

    // バリデーション
    let isValid = true;
    if (!namespace) {
      document.getElementById("namespace-empty-error").style.display = "block";
      isValid = false;
    } else {
      document.getElementById("namespace-empty-error").style.display = "none";
    }
    if (!bucketPath) {
      document.getElementById("path-empty-error").style.display = "block";
      isValid = false;
    } else {
      document.getElementById("path-empty-error").style.display = "none";
    }
    if (!privateKey) {
      document.getElementById("private-key-empty-error").style.display = "block";
      isValid = false;
    } else {
      document.getElementById("private-key-empty-error").style.display = "none";
    }
    if (!region) {
      document.getElementById("region-empty-error").style.display = "block";
      isValid = false;
    } else {
      document.getElementById("region-empty-error").style.display = "none";
    }
    if (!isValid) return;

    preauth_url = `https://${namespace}.objectstorage.${region}.oci.customer-oci.com/p/${privateKey}/n/${namespace}/b/${bucketPath}/o/`;
    Connect(preauth_url);

  }


</script>

</html>
